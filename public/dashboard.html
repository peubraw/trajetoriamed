<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Trajet√≥riaMed CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .dashboard-container {
            background: #f8fafc;
            min-height: 100vh;
        }

        .header-bar {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.2;
            margin-top: 12px;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            margin-top: 4px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-up {
            background: #dcfce7;
            color: #166534;
        }

        .badge-down {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-neutral {
            background: #f1f5f9;
            color: #475569;
        }

        .nav-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .ranking-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .ranking-table thead th {
            background: #f8fafc;
            color: #475569;
            font-weight: 600;
            text-align: left;
            padding: 12px 16px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ranking-table tbody tr {
            background: white;
            transition: all 0.2s ease;
        }

        .ranking-table tbody tr:hover {
            background: #f8fafc;
            transform: translateX(4px);
        }

        .ranking-table tbody td {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

        .ranking-table tbody td:first-child {
            border-left: 1px solid #e2e8f0;
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        .ranking-table tbody td:last-child {
            border-right: 1px solid #e2e8f0;
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .rank-medal {
            font-size: 24px;
            display: inline-block;
            width: 32px;
            text-align: center;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.6s ease;
        }

        .metric-positive {
            color: #16a34a;
        }

        .metric-negative {
            color: #dc2626;
        }

        .loading-spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
        }

        /* Sidebar Menu */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .sidebar-logo {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-user {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            font-weight: 500;
            font-size: 15px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: white;
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-left-color: white;
        }

        .menu-item i {
            width: 24px;
            margin-right: 12px;
            font-size: 18px;
        }

        .menu-section {
            padding: 20px 24px 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .main-content {
            margin-left: 280px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="flex">
        <!-- Sidebar Menu -->
        <aside class="sidebar">
            <!-- Logo -->
            <div class="sidebar-logo">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-purple-600 text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-white font-bold text-lg">Trajet√≥riaMed</h2>
                        <p class="text-white text-opacity-70 text-xs">Sistema CRM</p>
                    </div>
                </div>
            </div>

            <!-- User Info -->
            <div class="sidebar-user">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-white font-semibold text-sm" id="userName">Leandro</p>
                        <p class="text-white text-opacity-60 text-xs">Administrador</p>
                    </div>
                </div>
            </div>

            <!-- Menu -->
            <nav class="py-4">
                <div class="menu-section">Principal</div>
                <a href="/dashboard.html" class="menu-item active admin-only">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="/crm-kanban.html" class="menu-item">
                    <i class="fas fa-columns"></i>
                    CRM Kanban
                </a>
                <a href="/crm-chat.html" class="menu-item">
                    <i class="fab fa-whatsapp"></i>
                    Chat WhatsApp
                </a>
                <a href="/whatsapp.html" class="menu-item admin-only">
                    <i class="fas fa-qrcode"></i>
                    Conectar WhatsApp
                </a>

                <div class="menu-section admin-only">Configura√ß√µes</div>
                <a href="/bot-config.html" class="menu-item admin-only">
                    <i class="fas fa-robot"></i>
                    Configurar Bot
                </a>
                <a href="/webhooks.html" class="menu-item admin-only">
                    <i class="fas fa-link"></i>
                    Webhooks
                </a>

                <div class="menu-section admin-only">Sistema</div>
                <a href="/settings.html" class="menu-item admin-only">
                    <i class="fas fa-cog"></i>
                    Configura√ß√µes
                </a>
                <a href="#" onclick="logout(); return false;" class="menu-item">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-1">
            <div class="dashboard-container">
                <!-- Header -->
                <div class="header-bar px-8 py-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button class="md:hidden text-gray-600 hover:text-gray-800" onclick="toggleSidebar()">
                                <i class="fas fa-bars text-2xl"></i>
                            </button>
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <i class="fas fa-chart-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-800">Dashboard CRM</h1>
                                    <p class="text-sm text-gray-500">An√°lise de Vendas e Performance</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="hidden md:flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-lg">
                                <i class="fas fa-clock text-gray-500"></i>
                                <span class="text-sm text-gray-600" id="currentTime">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>

        <!-- Main Content -->
        <div class="px-8 py-6">
            
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Faturamento Realizado -->
                <div class="stat-card">
                    <div class="flex items-start justify-between">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <i class="fas fa-dollar-sign text-white"></i>
                        </div>
                        <span class="badge badge-neutral" id="revenueBadge">--</span>
                    </div>
                    <div class="stat-value text-green-600" id="revenue">R$ 0,00</div>
                    <div class="stat-label">Faturamento Realizado</div>
                    <div class="text-xs text-gray-400 mt-2">Vendas confirmadas este m√™s</div>
                </div>

                <!-- Pipeline Ponderado -->
                <div class="stat-card">
                    <div class="flex items-start justify-between">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <span class="badge badge-neutral" id="pipelineBadge">--</span>
                    </div>
                    <div class="stat-value text-blue-600" id="pipeline">R$ 0,00</div>
                    <div class="stat-label">Pipeline Ponderado</div>
                    <div class="text-xs text-gray-400 mt-2">Previs√£o de fechamento</div>
                </div>

                <!-- Aguardando Pagamento -->
                <div class="stat-card">
                    <div class="flex items-start justify-between">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <span class="badge badge-neutral" id="waitingCount">0 leads</span>
                    </div>
                    <div class="stat-value text-amber-600" id="waiting">R$ 0,00</div>
                    <div class="stat-label">Aguardando Pagamento</div>
                    <div class="text-xs text-gray-400 mt-2">Checkouts iniciados</div>
                </div>

                <!-- Dinheiro na Mesa -->
                <div class="stat-card">
                    <div class="flex items-start justify-between">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <i class="fas fa-exclamation-triangle text-white"></i>
                        </div>
                        <span class="badge badge-neutral" id="lostCount">0 leads</span>
                    </div>
                    <div class="stat-value text-red-600" id="lost">R$ 0,00</div>
                    <div class="stat-label">Dinheiro na Mesa</div>
                    <div class="text-xs text-gray-400 mt-2">Leads perdidos</div>
                </div>
            </div>

            <!-- M√©tricas Operacionais -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-users text-purple-600"></i>
                        </div>
                        <div class="text-xs text-gray-500 font-semibold">TOTAL LEADS</div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800" id="totalLeads">0</div>
                </div>

                <div class="stat-card">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div class="text-xs text-gray-500 font-semibold">TAXA CONVERS√ÉO</div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800" id="conversionRate">0%</div>
                </div>

                <div class="stat-card">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-comment-dots text-blue-600"></i>
                        </div>
                        <div class="text-xs text-gray-500 font-semibold">CONVERSAS ATIVAS</div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800" id="activeChats">0</div>
                </div>

                <div class="stat-card">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                            <i class="fas fa-fire text-amber-600"></i>
                        </div>
                        <div class="text-xs text-gray-500 font-semibold">LEADS QUENTES</div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800" id="hotLeads">0</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Pipeline por Etapa -->
                <div class="chart-card">
                    <h3 class="section-title">Pipeline por Etapa</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="pipelineChart"></canvas>
                    </div>
                </div>

                <!-- Motivos de Perda -->
                <div class="chart-card">
                    <h3 class="section-title">Motivos de Perda</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="lostReasonsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Leads por Canal -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="chart-card">
                    <h3 class="section-title">Leads por Canal de Aquisi√ß√£o</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="channelChart"></canvas>
                    </div>
                </div>

                <!-- Temperatura dos Leads -->
                <div class="chart-card">
                    <h3 class="section-title">Temperatura dos Leads</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Ranking de Vendedores -->
            <div class="chart-card mb-8">
                <h3 class="section-title">üèÜ Ranking de Vendedores</h3>
                <div class="overflow-x-auto">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Vendedor</th>
                                <th>Leads</th>
                                <th>Taxa de Convers√£o</th>
                                <th>Faturamento</th>
                                <th>Comiss√£o (10%)</th>
                                <th>Performance</th>
                                <th>Badges</th>
                            </tr>
                        </thead>
                        <tbody id="sellersRanking">
                            <tr>
                                <td colspan="8" class="text-center text-gray-400 py-8">
                                    <div class="loading-spinner"></div>
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
    </div>

    <script>
        let pipelineChart, lostReasonsChart, channelChart, temperatureChart;

        // Carregar dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autentica√ß√£o primeiro
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return;
            }
            
            loadDashboard();
            updateTime();
            setInterval(updateTime, 1000);
            // Atualizar a cada 30 segundos
            setInterval(loadDashboard, 30000);
        });

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', { credentials: 'include' });
                const data = await response.json();
                
                if (!data.authenticated) {
                    window.location.href = '/login.html';
                    return false;
                }
                
                const user = data.user;
                
                // Vendedores n√£o devem acessar o dashboard - redirecionar para CRM
                if (user.role !== 'admin') {
                    console.log('Vendedor detectado - redirecionando para CRM Kanban');
                    window.location.href = '/crm-kanban.html';
                    return false;
                }
                
                // Atualizar informa√ß√µes do usu√°rio no sidebar
                const userName = document.getElementById('userName');
                if (userName) userName.textContent = user.name || 'Usu√°rio';
                
                // Atualizar role no sidebar
                const userRoleElement = document.querySelector('.sidebar-user p.text-xs');
                if (userRoleElement) {
                    userRoleElement.textContent = 'Administrador';
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao verificar autentica√ß√£o:', error);
                window.location.href = '/login.html';
                return false;
            }
        }

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = `${hours}:${minutes}`;
            }
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
        }

        async function loadDashboard() {
            try {
                await Promise.all([
                    loadKPIs(),
                    loadPipeline(),
                    loadLostReasons(),
                    loadSellers(),
                    loadOperationalMetrics()
                ]);
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        async function loadKPIs() {
            const response = await fetch('/api/crm/dashboard/stats', { credentials: 'include' });
            const data = await response.json();

            if (data.success) {
                const stats = data.stats;
                
                // KPIs principais
                document.getElementById('revenue').textContent = formatCurrency(stats.revenue_realized);
                document.getElementById('pipeline').textContent = formatCurrency(stats.pipeline_weighted);
                document.getElementById('waiting').textContent = formatCurrency(stats.awaiting_payment);
                document.getElementById('lost').textContent = formatCurrency(stats.money_lost);

                // Badges
                updateBadge('revenueBadge', stats.revenue_growth || 0);
                updateBadge('pipelineBadge', stats.pipeline_growth || 0);
            }
        }

        async function loadOperationalMetrics() {
            const response = await fetch('/api/crm/leads', { credentials: 'include' });
            const data = await response.json();

            if (data.success) {
                const leads = data.leads;
                const total = leads.length;
                const converted = leads.filter(l => l.stage_is_success).length;
                const active = leads.filter(l => l.bot_active).length;
                const hot = leads.filter(l => l.temperature === 'hot').length;

                document.getElementById('totalLeads').textContent = total;
                document.getElementById('conversionRate').textContent = 
                    total > 0 ? ((converted / total) * 100).toFixed(1) + '%' : '0%';
                document.getElementById('activeChats').textContent = active;
                document.getElementById('hotLeads').textContent = hot;

                // Gr√°fico de canais
                const channels = {};
                leads.forEach(lead => {
                    const channel = lead.channel || 'manual';
                    channels[channel] = (channels[channel] || 0) + 1;
                });
                createChannelChart(channels);

                // Gr√°fico de temperatura
                const temps = {
                    cold: leads.filter(l => l.temperature === 'cold').length,
                    warm: leads.filter(l => l.temperature === 'warm').length,
                    hot: leads.filter(l => l.temperature === 'hot').length
                };
                createTemperatureChart(temps);

                // Contadores
                const waitingCount = leads.filter(l => l.stage_name && l.stage_name.includes('Aguardando')).length;
                const lostCount = leads.filter(l => l.stage_is_lost).length;
                document.getElementById('waitingCount').textContent = `${waitingCount} leads`;
                document.getElementById('lostCount').textContent = `${lostCount} leads`;
            }
        }

        async function loadPipeline() {
            const response = await fetch('/api/crm/leads', { credentials: 'include' });
            const data = await response.json();

            if (data.success) {
                const leads = data.leads;
                const stages = {};

                leads.forEach(lead => {
                    const stageName = lead.stage_name || 'Sem Etapa';
                    if (!stages[stageName]) {
                        stages[stageName] = 0;
                    }
                    stages[stageName] += parseFloat(lead.potential_value || 0);
                });

                createPipelineChart(stages);
            }
        }

        async function loadLostReasons() {
            const response = await fetch('/api/crm/dashboard/lost-reasons', { credentials: 'include' });
            const data = await response.json();

            if (data.success) {
                createLostReasonsChart(data.reasons);
            }
        }

        async function loadSellers() {
            const response = await fetch('/api/crm/dashboard/sellers', { credentials: 'include' });
            const data = await response.json();

            if (data.success) {
                renderSellersRanking(data.sellers);
            }
        }

        function createPipelineChart(stages) {
            const ctx = document.getElementById('pipelineChart');
            if (pipelineChart) pipelineChart.destroy();

            const labels = Object.keys(stages);
            const values = Object.values(stages);

            pipelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor em Pipeline (R$)',
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2})
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + value.toLocaleString('pt-BR')
                            }
                        }
                    }
                }
            });
        }

        function createLostReasonsChart(reasons) {
            const ctx = document.getElementById('lostReasonsChart');
            if (lostReasonsChart) lostReasonsChart.destroy();

            if (!reasons || reasons.length === 0) {
                lostReasonsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Sem perdas'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e2e8f0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                return;
            }

            const labels = reasons.map(r => r.reason || 'N√£o informado');
            const values = reasons.map(r => r.count);
            const colors = ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6', '#ec4899'];

            lostReasonsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createChannelChart(channels) {
            const ctx = document.getElementById('channelChart');
            if (channelChart) channelChart.destroy();

            const channelNames = {
                whatsapp: 'WhatsApp',
                instagram: 'Instagram',
                facebook: 'Facebook',
                website: 'Website',
                manual: 'Manual'
            };

            const labels = Object.keys(channels).map(k => channelNames[k] || k);
            const values = Object.values(channels);
            const colors = ['#25D366', '#E4405F', '#1877F2', '#667eea', '#64748b'];

            channelChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        function createTemperatureChart(temps) {
            const ctx = document.getElementById('temperatureChart');
            if (temperatureChart) temperatureChart.destroy();

            temperatureChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Frios', 'Mornos', 'Quentes'],
                    datasets: [{
                        label: 'Quantidade de Leads',
                        data: [temps.cold, temps.warm, temps.hot],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderSellersRanking(sellers) {
            const tbody = document.getElementById('sellersRanking');

            if (!sellers || sellers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-gray-400 py-8">
                            Nenhum vendedor com leads atribu√≠dos
                        </td>
                    </tr>
                `;
                return;
            }

            const maxRevenue = Math.max(...sellers.map(s => parseFloat(s.total_revenue || 0)));
            const maxConversion = Math.max(...sellers.map(s => parseFloat(s.conversion_rate || 0)));

            tbody.innerHTML = sellers.map((seller, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                const conversion = parseFloat(seller.conversion_rate || 0);
                const revenue = parseFloat(seller.total_revenue || 0);
                const commission = revenue * 0.1;

                let badges = [];
                if (revenue === maxRevenue && revenue > 0) {
                    badges.push('<span class="badge" style="background: #fef3c7; color: #92400e;">üëë Alpha</span>');
                }
                if (conversion === maxConversion && conversion > 0) {
                    badges.push('<span class="badge" style="background: #dbeafe; color: #1e40af;">üéØ Sniper</span>');
                }

                return `
                    <tr>
                        <td>
                            <span class="rank-medal">${medal}</span>
                        </td>
                        <td class="font-semibold text-gray-800">${seller.name || 'N√£o atribu√≠do'}</td>
                        <td>${seller.total_leads || 0} leads</td>
                        <td>
                            <div class="flex items-center gap-2">
                                <span class="font-semibold ${conversion >= 50 ? 'metric-positive' : ''}">${conversion.toFixed(1)}%</span>
                                <div class="progress-bar" style="width: 100px;">
                                    <div class="progress-fill" style="width: ${Math.min(conversion, 100)}%;"></div>
                                </div>
                            </div>
                        </td>
                        <td class="font-bold metric-positive">${formatCurrency(revenue)}</td>
                        <td class="font-semibold text-purple-600">${formatCurrency(commission)}</td>
                        <td>
                            <div class="progress-bar" style="width: 80px;">
                                <div class="progress-fill" style="width: ${Math.min((revenue / (maxRevenue || 1)) * 100, 100)}%;"></div>
                            </div>
                        </td>
                        <td>${badges.join(' ')}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateBadge(id, value) {
            const badge = document.getElementById(id);
            const numValue = parseFloat(value);
            
            if (numValue > 0) {
                badge.className = 'badge badge-up';
                badge.innerHTML = `<i class="fas fa-arrow-up mr-1"></i> +${numValue.toFixed(1)}%`;
            } else if (numValue < 0) {
                badge.className = 'badge badge-down';
                badge.innerHTML = `<i class="fas fa-arrow-down mr-1"></i> ${numValue.toFixed(1)}%`;
            } else {
                badge.className = 'badge badge-neutral';
                badge.textContent = '--';
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        function logout() {
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
                .then(() => window.location.href = '/login.html');
        }
    </script>
</body>
</html>
