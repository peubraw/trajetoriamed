<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CRM Kanban - Pipeline de Vendas</title>
    <script src="/js/menu.js?v=2.3"></script>
    <style>
        /* Kanban Inteligente v2.3.1 - Enhanced Cards & Drag Drop */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        #main-content {
            margin-left: 288px;
            transition: margin-left 0.3s;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            color: #1f2937;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .filters {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .kanban-board {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .kanban-column {
            min-width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 280px);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 3px solid;
        }

        .column-title {
            font-weight: 700;
            font-size: 16px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-count {
            background: #f3f4f6;
            color: #374151;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .column-stats {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .cards-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .lead-card {
            background: white;
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: grab;
            transition: all 0.2s;
            border-left: 4px solid #667eea;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }

        .lead-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .lead-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .card-name {
            font-weight: 700;
            font-size: 15px;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .channel-icon {
            font-size: 16px;
        }

        .bot-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .bot-active {
            background: #d1fae5;
            color: #065f46;
        }

        .bot-paused {
            background: #fee2e2;
            color: #991b1b;
        }

        .bot-alert {
            background: #fef3c7;
            color: #92400e;
        }

        .card-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
            margin: 12px 0;
        }

        .card-detail-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .card-value {
            font-weight: 700;
            font-size: 16px;
            color: #059669;
        }

        .card-temperature {
            font-size: 20px;
        }

        .card-owner {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 11px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-view {
            background: #e0e7ff;
            color: #4338ca;
        }

        .btn-bot {
            background: #dcfce7;
            color: #166534;
        }

        .btn-bot.paused {
            background: #fecaca;
            color: #991b1b;
        }

        .btn-message {
            background: #10b981;
            color: white;
        }

        .btn-message:hover {
            background: #059669;
        }

        .btn-delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-delete:hover {
            background: #fecaca;
        }

        /* Novos elementos do card - Milestone 2 */
        .engagement-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 20px;
            line-height: 1;
            z-index: 10;
        }

        .card-subheader {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .score-badge {
            background: #fbbf24;
            color: #78350f;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .time-alert {
            background: #fee2e2;
            color: #991b1b;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-icon {
            display: inline-block;
            width: 20px;
            text-align: center;
        }

        .hot-lead {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
            background: linear-gradient(145deg, #ffffff, #fffbeb);
        }

        .hot-lead:hover {
            box-shadow: 0 6px 24px rgba(251, 191, 36, 0.4);
        }

        .warm-lead {
            border: 2px solid #94a3b8;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
        }

        /* Posicionar card relativamente para o badge de engagement */
        .lead-card {
            position: relative;
        }

        /* Drag & Drop Enhanced Visual Feedback */
        .kanban-column.drag-over {
            background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
            border: 2px dashed #667eea;
            transform: scale(1.02);
        }

        .kanban-column.drag-over .column-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .lead-card.dragging {
            opacity: 0.4;
            transform: rotate(3deg);
            cursor: grabbing;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #111827;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #9ca3af;
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section h3 {
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .info-item value {
            font-weight: 600;
            color: #111827;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .timeline-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-content p {
            font-size: 14px;
            color: #374151;
            margin-bottom: 4px;
        }

        .timeline-content small {
            font-size: 12px;
            color: #9ca3af;
        }

        .notes-area {
            margin-top: 16px;
        }

        .notes-area textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            min-height: 100px;
            font-family: inherit;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="main-content">
    <div class="header">
        <h1>
            <span>üéØ</span>
            CRM Kanban - Pipeline de Vendas
        </h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshBoard()">
                üîÑ Atualizar
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='crm-dashboard.html'">
                üìä Dashboard
            </button>
            <button class="btn btn-primary" onclick="exportLeads()">
                üì• Exportar CSV
            </button>
            <button class="btn btn-primary" onclick="showAddLeadModal()">
                ‚ûï Novo Lead
            </button>
        </div>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>üîç Buscar</label>
            <input type="text" id="searchInput" placeholder="Nome, telefone, email..." onkeyup="applyFilters()">
        </div>
        <div class="filter-group">
            <label>üë§ Vendedor</label>
            <select id="sellerFilter" onchange="applyFilters()">
                <option value="">Todos</option>
            </select>
        </div>
        <div class="filter-group">
            <label>üå°Ô∏è Temperatura</label>
            <select id="temperatureFilter" onchange="applyFilters()">
                <option value="">Todas</option>
                <option value="hot">üî• Quente</option>
                <option value="warm">üå§Ô∏è Morno</option>
                <option value="cold">‚ùÑÔ∏è Frio</option>
            </select>
        </div>
    </div>

    <div id="kanbanBoard" class="kanban-board">
        <div class="loading">Carregando pipeline... üöÄ</div>
    </div>

    <!-- Modal de Detalhes do Lead -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalLeadName">Detalhes do Lead</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>

            <div class="modal-section">
                <h3>üìã Informa√ß√µes B√°sicas</h3>
                <div class="info-grid" id="modalLeadInfo"></div>
            </div>

            <div class="modal-section">
                <h3>üìù Notas</h3>
                <div class="notes-area">
                    <textarea id="newNoteText" placeholder="Adicionar nova nota..."></textarea>
                    <button class="btn btn-primary" style="margin-top: 8px;" onclick="addNote()">
                        üíæ Salvar Nota
                    </button>
                </div>
                <div id="notesList" style="margin-top: 16px;"></div>
            </div>

            <div class="modal-section">
                <h3>üìÖ Hist√≥rico de Atividades</h3>
                <div class="timeline" id="modalTimeline"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let allLeads = [];
        let allStages = [];
        let currentLeadId = null;
        let socket = null;

        // Carregar board inicial
        document.addEventListener('DOMContentLoaded', () => {
            loadKanbanBoard();
            initSocketIO();
        });

        // Inicializar Socket.IO
        function initSocketIO() {
            socket = io();

            socket.on('connect', () => {
                console.log('üîå Conectado ao Socket.IO');
                // Entrar na sala do CRM (assumindo userId est√° na sess√£o)
                // TODO: Pegar userId da sess√£o ou API
                socket.emit('join-crm', 1); // Tempor√°rio: hardcoded para Leandro (user 1)
            });

            socket.on('new-lead', (data) => {
                console.log('üÜï Novo lead detectado:', data);
                loadKanbanBoard(); // Recarregar board
                showNotification('Novo Lead!', 'Um novo lead foi adicionado ao pipeline.');
            });

            socket.on('lead-moved', (data) => {
                console.log('üîÑ Lead movido:', data);
                loadKanbanBoard(); // Recarregar board
            });

            socket.on('bot-toggled', (data) => {
                console.log('ü§ñ Bot alterado:', data);
                loadKanbanBoard(); // Recarregar board
            });

            socket.on('hot-lead', (data) => {
                console.log('üî• Lead quente:', data);
                showNotification('Lead Quente! üî•', 'Um lead est√° com alta probabilidade de convers√£o.');
            });

            socket.on('sla-breach', (data) => {
                console.log('‚ö†Ô∏è SLA violado:', data);
                showNotification('SLA Violado! ‚ö†Ô∏è', 'Um lead precisa de aten√ß√£o urgente.');
            });

            socket.on('disconnect', () => {
                console.log('üîå Desconectado do Socket.IO');
            });
        }

        function showNotification(title, message) {
            // Notifica√ß√£o nativa do navegador
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message, icon: '/favicon.ico' });
            } else if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification(title, { body: message });
                    }
                });
            }
            
            // Fallback: alert visual
            console.log(`üì¢ ${title}: ${message}`);
        }

        async function loadKanbanBoard() {
            try {
                // Buscar est√°gios
                const stagesRes = await fetch('/api/crm/stages', { credentials: 'include' });
                const stagesData = await stagesRes.json();
                
                if (!stagesData.success) {
                    // Criar est√°gios padr√£o
                    await fetch('/api/crm/stages/init', { 
                        method: 'POST', 
                        credentials: 'include' 
                    });
                    return loadKanbanBoard(); // Retry
                }

                allStages = stagesData.stages;

                // Buscar leads
                const leadsRes = await fetch('/api/crm/leads', { credentials: 'include' });
                const leadsData = await leadsRes.json();
                allLeads = leadsData.leads || [];

                renderBoard();
            } catch (error) {
                console.error('Erro ao carregar board:', error);
                alert('Erro ao carregar o Kanban. Verifique sua autentica√ß√£o.');
            }
        }

        function renderBoard() {
            const board = document.getElementById('kanbanBoard');
            board.innerHTML = '';

            allStages.forEach(stage => {
                const stageLeads = allLeads.filter(l => l.stage_id === stage.id);
                const totalValue = stageLeads.reduce((sum, l) => sum + parseFloat(l.potential_value || 0), 0);

                const column = document.createElement('div');
                column.className = 'kanban-column';
                column.dataset.stageId = stage.id;

                column.innerHTML = `
                    <div class="column-header" style="border-color: ${stage.color}">
                        <div class="column-title" style="color: ${stage.color}">
                            ${stage.name}
                        </div>
                        <div class="column-count">${stageLeads.length}</div>
                    </div>
                    <div class="column-stats">
                        üí∞ R$ ${totalValue.toFixed(2).replace('.', ',')}
                    </div>
                    <div class="cards-container" ondrop="drop(event)" ondragover="allowDrop(event)">
                        ${stageLeads.length === 0 ? '<div class="empty-state">Nenhum lead nesta etapa</div>' : ''}
                    </div>
                `;

                const container = column.querySelector('.cards-container');
                stageLeads.forEach(lead => {
                    container.appendChild(createLeadCard(lead));
                });

                board.appendChild(column);
            });
        }

        function createLeadCard(lead) {
            const card = document.createElement('div');
            card.className = 'lead-card';
            card.draggable = true;
            card.dataset.leadId = lead.id;

            // Term√¥metro de Engajamento (baseado em minutes_since_response)
            const minutesSince = lead.minutes_since_response || 9999;
            let engagement = '';
            if (minutesSince < 120) engagement = 'üî•üî•üî•'; // < 2h
            else if (minutesSince < 480) engagement = 'üî•üî•'; // 2-8h
            else if (minutesSince < 1440) engagement = 'üî•'; // 8-24h
            else engagement = '‚ùÑÔ∏è'; // > 24h

            const channelIcon = {
                'whatsapp': 'üì±',
                'instagram': 'üì∑',
                'facebook': 'üìò',
                'manual': '‚úçÔ∏è'
            }[lead.channel] || 'üì±';

            // Badge do Bot
            let botBadge = '';
            if (lead.bot_active) {
                botBadge = '<span class="bot-status bot-active">üü¢ Bot Ativo</span>';
            } else if (lead.bot_paused_at) {
                botBadge = '<span class="bot-status bot-paused">üî¥ Pausado</span>';
            } else {
                botBadge = '<span class="bot-status bot-warning">üü° Interven√ß√£o</span>';
            }

            // Alerta de Tempo (SLA)
            let timeAlert = '';
            if (minutesSince > 120) {
                const hoursSince = Math.floor(minutesSince / 60);
                timeAlert = `<div class="time-alert">‚ö†Ô∏è ${hoursSince > 24 ? Math.floor(hoursSince/24) + 'd' : hoursSince + 'h'} sem resposta</div>`;
            }

            // √öltima intera√ß√£o formatada
            const lastInteraction = lead.last_response_at ? 
                formatTimeAgo(lead.last_response_at) : 
                'Nunca respondeu';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-name">
                        <span class="channel-icon">${channelIcon}</span>
                        <strong>${lead.name || 'Lead'}</strong>
                    </div>
                    <div class="engagement-badge">${engagement}</div>
                </div>
                
                <div class="card-subheader">
                    ${botBadge}
                    ${lead.score ? `<span class="score-badge">‚≠ê ${lead.score}</span>` : ''}
                </div>

                <div class="card-details">
                    ${lead.assigned_name ? 
                        `<div class="card-detail-row">
                            <span class="detail-icon">üë®‚Äçüíº</span> 
                            <strong style="color: #3b82f6;">${lead.assigned_name}</strong>
                        </div>` : 
                        `<div class="card-detail-row" style="color: #ef4444;">
                            <span class="detail-icon">‚ö†Ô∏è</span> 
                            <strong>Sem vendedor</strong>
                        </div>`
                    }
                    
                    ${lead.interested_course ? 
                        `<div class="card-detail-row">
                            <span class="detail-icon">üìö</span> 
                            <strong>${lead.interested_course}</strong>
                        </div>` : ''
                    }
                    
                    ${lead.rqe ? 
                        `<div class="card-detail-row">
                            <span class="detail-icon">üè•</span> 
                            RQE: ${lead.rqe}
                        </div>` : ''
                    }
                    
                    ${lead.specialty ? 
                        `<div class="card-detail-row">
                            <span class="detail-icon">ü©∫</span> 
                            ${lead.specialty}
                        </div>` : ''
                    }
                    
                    ${lead.state ? 
                        `<div class="card-detail-row">
                            <span class="detail-icon">üìç</span> 
                            ${lead.state}
                        </div>` : ''
                    }
                    
                    <div class="card-detail-row">
                        <span class="detail-icon">üìû</span> 
                        <span style="font-family: monospace; font-size: 11px;">${lead.phone || 'Sem telefone'}</span>
                    </div>
                    
                    <div class="card-detail-row" style="font-size: 11px; color: #6b7280;">
                        <span class="detail-icon">‚è±Ô∏è</span> 
                        ${lastInteraction}
                    </div>
                </div>

                ${timeAlert}

                <div class="card-footer">
                    <div class="card-value">
                        üí∞ R$ ${(parseFloat(lead.potential_value || 0)).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
                
                <div class="card-actions">
                    <button class="btn-small btn-view" onclick="openLeadDetails(${lead.id})" title="Ver detalhes completos">
                        üëÅÔ∏è Detalhes
                    </button>
                    <button class="btn-small btn-bot ${lead.bot_active ? '' : 'paused'}" 
                            onclick="toggleBot(${lead.id}, ${!lead.bot_active})"
                            title="${lead.bot_active ? 'Pausar automa√ß√£o' : 'Retomar automa√ß√£o'}">
                        ${lead.bot_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                    </button>
                    <button class="btn-small btn-message" onclick="openQuickMessage(${lead.id})" title="Enviar mensagem">
                        üí¨
                    </button>
                    <button class="btn-small btn-delete" onclick="deleteLead(${lead.id})" title="Remover lead">
                        üóëÔ∏è
                    </button>
                </div>
            `;

            // Drag events
            card.addEventListener('dragstart', drag);
            card.addEventListener('dragend', () => card.classList.remove('dragging'));

            // Adicionar classe especial para leads hot
            if (lead.score >= 80) {
                card.classList.add('hot-lead');
            } else if (lead.score >= 50) {
                card.classList.add('warm-lead');
            }

            return card;
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Agora';
            if (diffMins < 60) return `${diffMins}min atr√°s`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h atr√°s`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d atr√°s`;
        }

        // Drag and Drop - Enhanced com Bot Integration
        function drag(e) {
            e.dataTransfer.setData('leadId', e.target.dataset.leadId);
            e.target.classList.add('dragging');
            
            // Visual feedback
            e.dataTransfer.effectAllowed = 'move';
        }

        function allowDrop(e) {
            e.preventDefault();
            
            // Visual feedback durante hover
            const column = e.target.closest('.kanban-column');
            if (column && !column.classList.contains('drag-over')) {
                column.classList.add('drag-over');
                
                // Remove feedback de outras colunas
                document.querySelectorAll('.kanban-column.drag-over').forEach(col => {
                    if (col !== column) col.classList.remove('drag-over');
                });
            }
        }

        async function drop(e) {
            e.preventDefault();
            
            // Remove visual feedback
            document.querySelectorAll('.kanban-column.drag-over').forEach(col => {
                col.classList.remove('drag-over');
            });
            document.querySelectorAll('.lead-card.dragging').forEach(card => {
                card.classList.remove('dragging');
            });
            
            const leadId = parseInt(e.dataTransfer.getData('leadId'));
            const column = e.target.closest('.kanban-column');
            if (!column) return;
            
            const newStageId = parseInt(column.dataset.stageId);
            const lead = allLeads.find(l => l.id === leadId);
            const newStage = allStages.find(s => s.id === newStageId);
            
            if (!lead || !newStage) return;

            try {
                // 1. Mover lead para novo stage
                const moveRes = await fetch(`/api/crm/leads/${leadId}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ stageId: newStageId })
                });

                if (!moveRes.ok) {
                    alert('‚ùå Erro ao mover lead');
                    return;
                }

                // 2. L√≥gica de pausar/retomar bot baseado em stage
                const needsHuman = ['Negocia√ß√£o', 'Aguardando Pagamento'].includes(newStage.name);
                const needsBot = ['Triagem', 'Nutri√ß√£o'].includes(newStage.name);
                
                if (needsHuman && lead.bot_active) {
                    // Pausar bot automaticamente
                    await fetch('/api/whatsapp/bot-control', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            leadId: leadId,
                            action: 'pause',
                            reason: `Moved to ${newStage.name} - requires human attention`
                        })
                    });
                    console.log(`ü§ñ Bot pausado automaticamente para ${lead.name} (stage: ${newStage.name})`);
                    
                } else if (needsBot && !lead.bot_active && lead.bot_paused_at) {
                    // Retomar bot automaticamente
                    await fetch('/api/whatsapp/bot-control', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            leadId: leadId,
                            action: 'resume',
                            reason: `Moved to ${newStage.name} - bot can handle`
                        })
                    });
                    console.log(`ü§ñ Bot retomado automaticamente para ${lead.name} (stage: ${newStage.name})`);
                }

                // 3. Registrar atividade no hist√≥rico
                await fetch('/api/crm/activity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        leadId: leadId,
                        type: 'stage_change',
                        description: `Moved to ${newStage.name}`,
                        metadata: {
                            from_stage: lead.stage_id,
                            to_stage: newStageId,
                            bot_action: needsHuman ? 'paused' : (needsBot ? 'resumed' : 'unchanged')
                        }
                    })
                });

                // 4. Recarregar board
                await loadKanbanBoard();
                
            } catch (error) {
                console.error('Erro ao mover lead:', error);
                alert('‚ùå Erro ao processar movimenta√ß√£o');
            }
        }

        // Bot Toggle
        async function toggleBot(leadId, activate) {
            try {
                const res = await fetch(`/api/crm/leads/${leadId}/bot-toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ active: activate })
                });

                if (res.ok) {
                    await loadKanbanBoard();
                }
            } catch (error) {
                console.error('Erro ao alternar bot:', error);
            }
        }

        // Deletar Lead
        async function deleteLead(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) return;

            const confirmMsg = `‚ö†Ô∏è ATEN√á√ÉO: Tem certeza que deseja DELETAR permanentemente este lead?\n\n` +
                              `Nome: ${lead.name || 'Sem nome'}\n` +
                              `Telefone: ${lead.phone}\n` +
                              `Curso: ${lead.interested_course || 'N/A'}\n\n` +
                              `Esta a√ß√£o N√ÉO pode ser desfeita!`;

            if (!confirm(confirmMsg)) return;

            try {
                const res = await fetch(`/api/crm/leads/${leadId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const data = await res.json();

                if (res.ok) {
                    alert('‚úÖ Lead deletado com sucesso!');
                    await loadKanbanBoard();
                } else {
                    alert('‚ùå Erro: ' + (data.message || 'N√£o foi poss√≠vel deletar o lead'));
                }
            } catch (error) {
                console.error('Erro ao deletar lead:', error);
                alert('‚ùå Erro ao deletar lead. Tente novamente.');
            }
        }

        // Abrir WhatsApp Web
        function openQuickMessage(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) return;

            // Limpar telefone (remover caracteres especiais)
            const cleanPhone = lead.phone.replace(/\D/g, '');
            
            // Abrir WhatsApp Web com o n√∫mero do lead
            const whatsappUrl = `https://web.whatsapp.com/send?phone=${cleanPhone}`;
            window.open(whatsappUrl, '_blank');
            
            // Pausar bot automaticamente quando vendedor assumir conversa
            fetch('/api/whatsapp/bot-control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    leadId: leadId,
                    action: 'pause',
                    reason: 'Vendedor iniciou conversa manual via WhatsApp Web'
                })
            }).catch(err => console.log('Aviso: n√£o foi poss√≠vel pausar o bot automaticamente'));
        }

        async function openLeadDetails(leadId) {
            currentLeadId = leadId;
            const lead = allLeads.find(l => l.id === leadId);

            document.getElementById('modalLeadName').textContent = lead.name || lead.phone;

            // Informa√ß√µes b√°sicas - apenas campos essenciais
            const infoHTML = `
                <div class="info-item">
                    <label>üìû Telefone</label>
                    <value>${lead.phone}</value>
                </div>
                ${lead.email ? `
                <div class="info-item">
                    <label>üìß Email</label>
                    <value>${lead.email}</value>
                </div>
                ` : ''}
                ${lead.interested_course ? `
                <div class="info-item">
                    <label>üéì Curso de Interesse</label>
                    <value>${lead.interested_course}</value>
                </div>
                ` : ''}
                <div class="info-item">
                    <label>üå°Ô∏è Temperatura</label>
                    <value>${lead.temperature === 'hot' ? 'üî• Quente' : lead.temperature === 'warm' ? 'üå§Ô∏è Morno' : '‚ùÑÔ∏è Frio'}</value>
                </div>
                <div class="info-item">
                    <label>ü§ñ Bot</label>
                    <value>${lead.bot_active ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}</value>
                </div>
            `;
            document.getElementById('modalLeadInfo').innerHTML = infoHTML;

            // Buscar atividades
            try {
                const res = await fetch(`/api/crm/leads/${leadId}/activities`, { 
                    credentials: 'include' 
                });
                const data = await res.json();
                
                const timeline = document.getElementById('modalTimeline');
                if (data.activities && data.activities.length > 0) {
                    timeline.innerHTML = data.activities.slice(0, 10).map(act => `
                        <div class="timeline-item">
                            <div class="timeline-icon">üìå</div>
                            <div class="timeline-content">
                                <p>${act.description}</p>
                                <small>${new Date(act.created_at).toLocaleString('pt-BR')}</small>
                            </div>
                        </div>
                    `).join('');
                } else {
                    timeline.innerHTML = '<p style="color: #9ca3af;">Nenhuma atividade registrada</p>';
                }
            } catch (error) {
                console.error('Erro ao buscar atividades:', error);
            }

            document.getElementById('leadModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('leadModal').classList.remove('show');
        }

        async function addNote() {
            const noteText = document.getElementById('newNoteText').value.trim();
            if (!noteText) return;

            try {
                const res = await fetch(`/api/crm/leads/${currentLeadId}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ note: noteText })
                });

                if (res.ok) {
                    document.getElementById('newNoteText').value = '';
                    alert('Nota adicionada!');
                }
            } catch (error) {
                console.error('Erro ao adicionar nota:', error);
            }
        }

        // Exportar
        function exportLeads() {
            window.location.href = '/api/crm/export';
        }

        // Atualizar
        function refreshBoard() {
            loadKanbanBoard();
        }

        // Filtros
        function applyFilters() {
            // TODO: Implementar filtros locais
            console.log('Filtros aplicados');
        }
    </script>
    </div>
</body>
</html>
