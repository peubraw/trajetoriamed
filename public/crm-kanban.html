<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Kanban - TrajetóriaMed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        
        .sidebar-gradient { background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); }
        .nav-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.1); border-left-color: #ffffff; }
        .nav-item.active { background: rgba(255, 255, 255, 0.15); border-left-color: #ffffff; }
        .content-container { background: #f7f9fc; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        
        .kanban-column { min-height: 600px; }
        .lead-card { transition: all 0.2s ease; cursor: grab; }
        .lead-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .lead-card:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; }
        .sortable-chosen { transform: rotate(2deg); }
    </style>
</head>
<body class="content-container">
    
    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="sidebar-gradient w-64 flex-shrink-0 hidden md:flex flex-col shadow-2xl">
            <div class="p-6 border-b border-white border-opacity-10">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-white font-bold text-lg">TrajetóriaMed</h1>
                        <p class="text-white text-opacity-60 text-xs">Sistema CRM</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                <a href="/dashboard.html" class="nav-item flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fas fa-home w-5"></i>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="/crm-kanban.html" class="nav-item active flex items-center px-4 py-3 text-white rounded-lg">
                    <i class="fas fa-columns w-5"></i>
                    <span class="ml-3">CRM Kanban</span>
                </a>
                <a href="/whatsapp.html" class="nav-item flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fab fa-whatsapp w-5"></i>
                    <span class="ml-3">WhatsApp</span>
                </a>
                <a href="/bot-config.html" class="nav-item flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fas fa-robot w-5"></i>
                    <span class="ml-3">Configurar Bot</span>
                </a>
                <a href="/webhooks.html" class="nav-item flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fas fa-link w-5"></i>
                    <span class="ml-3">Webhooks</span>
                </a>
                <div class="pt-6 mt-6 border-t border-white border-opacity-10">
                    <a href="/settings.html" class="nav-item flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                        <i class="fas fa-cog w-5"></i>
                        <span class="ml-3">Configurações</span>
                    </a>
                </div>
            </nav>
            
            <div class="p-4 border-t border-white border-opacity-10">
                <div class="flex items-center px-4 py-3 bg-white bg-opacity-10 rounded-lg">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-purple-700 flex items-center justify-center text-white font-semibold">
                        <span>LB</span>
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">Leandro Berti</p>
                        <p class="text-xs text-white text-opacity-60 truncate">Admin</p>
                    </div>
                    <button onclick="logout()" class="text-white text-opacity-60 hover:text-opacity-100">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Top Bar -->
            <header class="bg-white border-b border-gray-200 px-8 py-4 shadow-sm">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">CRM Kanban</h1>
                            <p class="text-sm text-gray-500 mt-1">Pipeline de vendas visual</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <button class="hidden md:flex items-center bg-gray-100 rounded-lg px-4 py-2">
                            <i class="fas fa-search text-gray-400 text-sm"></i>
                            <input type="text" placeholder="Buscar lead..." class="ml-2 bg-transparent outline-none text-sm text-gray-700 w-64">
                        </button>
                        
                        <button class="relative p-2.5 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition">
                            <i class="fas fa-bell text-lg"></i>
                            <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        
                        <div class="flex items-center space-x-3 pl-3 border-l border-gray-200">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-700 flex items-center justify-center text-white font-semibold shadow-lg">
                                <span>LB</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <main class="flex-1 overflow-x-auto overflow-y-hidden content-container p-8">
                
                <!-- Action Bar -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center space-x-3">
                            <button onclick="openAddLeadModal()" class="btn-primary text-white px-6 py-2.5 rounded-lg font-semibold flex items-center shadow-lg">
                                <i class="fas fa-plus mr-2"></i>
                                Novo Lead
                            </button>
                            <button class="bg-white border-2 border-gray-200 text-gray-700 px-5 py-2.5 rounded-lg font-medium hover:border-purple-300 hover:text-purple-600 transition">
                                <i class="fas fa-filter mr-2"></i>
                                Filtros
                            </button>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">Total: <strong class="text-gray-800" id="totalLeads">0</strong> leads</span>
                        </div>
                    </div>
                </div>
                
                <!-- Kanban Board -->
                <div class="flex gap-6 pb-6" style="min-width: max-content;">
                    
                    <!-- Column Template (will be generated dynamically) -->
                    <div id="kanbanColumns" class="flex gap-6"></div>
                    
                </div>
                
            </main>
            
        </div>
        
    </div>
    
    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">Adicionar Novo Lead</h3>
            </div>
            <form id="addLeadForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                        <input type="text" name="name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                        <input type="tel" name="phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Curso de Interesse</label>
                        <select name="course" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">Selecione...</option>
                            <option value="Perícia Médica">Perícia Médica</option>
                            <option value="Auditoria">Auditoria</option>
                            <option value="Medicina do Trabalho">Medicina do Trabalho</option>
                            <option value="Combo">Combo</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddLeadModal()" class="px-6 py-3 border-2 border-gray-200 text-gray-700 rounded-lg font-semibold hover:border-gray-300">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold shadow-lg">
                        Adicionar Lead
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let socket;
        let stages = [];
        
        // Initialize
        async function init() {
            console.log('Initializing CRM Kanban...');
            await checkAuth();
            await loadStages();
            await loadLeads();
            initSocket();
        }
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', { credentials: 'include' });
                console.log('Auth check:', response.ok);
                if (!response.ok) {
                    console.log('Not authenticated, redirecting...');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login.html';
            }
        }
        
        function logout() {
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
                .then(() => window.location.href = '/login.html');
        }
        
        async function loadStages() {
            try {
                console.log('Loading stages...');
                const response = await fetch('/api/crm/stages', { credentials: 'include' });
                console.log('Stages response:', response.status);
                
                if (response.ok) {
                    stages = await response.json();
                    console.log('Stages loaded:', stages);
                } else {
                    console.error('Failed to load stages:', response.status);
                    // Use default stages if API fails
                    stages = [
                        { id: 1, name: 'Novo Lead', order: 1 },
                        { id: 2, name: 'Contato Inicial', order: 2 },
                        { id: 3, name: 'Qualificação', order: 3 },
                        { id: 4, name: 'Proposta', order: 4 },
                        { id: 5, name: 'Negociação', order: 5 },
                        { id: 6, name: 'Fechado', order: 6 }
                    ];
                }
                renderColumns();
            } catch (error) {
                console.error('Error loading stages:', error);
                // Use default stages on error
                stages = [
                    { id: 1, name: 'Novo Lead', order: 1 },
                    { id: 2, name: 'Contato Inicial', order: 2 },
                    { id: 3, name: 'Qualificação', order: 3 },
                    { id: 4, name: 'Proposta', order: 4 },
                    { id: 5, name: 'Negociação', order: 5 },
                    { id: 6, name: 'Fechado', order: 6 }
                ];
                renderColumns();
            }
        }
        
        function renderColumns() {
            console.log('Rendering columns for stages:', stages);
            const container = document.getElementById('kanbanColumns');
            const colors = ['blue', 'purple', 'green', 'amber', 'red', 'gray', 'pink'];
            
            container.innerHTML = stages.map((stage, index) => `
                <div class="flex-shrink-0" style="width: 320px;">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 h-full flex flex-col">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-${colors[index % colors.length]}-500 mr-2"></div>
                                    <h3 class="font-semibold text-gray-800">${stage.name}</h3>
                                </div>
                                <span class="bg-gray-100 text-gray-600 text-xs font-semibold px-2 py-1 rounded-full" id="count-${stage.id}">0</span>
                            </div>
                        </div>
                        <div class="flex-1 p-4 space-y-3 kanban-column overflow-y-auto" id="column-${stage.id}" data-stage-id="${stage.id}">
                            <!-- Cards will be inserted here -->
                        </div>
                    </div>
                </div>
            `).join('');
            
            console.log('Columns rendered, initializing Sortable...');
            
            // Initialize Sortable for each column
            stages.forEach(stage => {
                const column = document.getElementById(`column-${stage.id}`);
                if (column) {
                    Sortable.create(column, {
                        group: 'kanban',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        onEnd: handleDrop
                    });
                }
            });
            
            console.log('Sortable initialized');
        }
        
        async function loadLeads() {
            try {
                console.log('Loading leads...');
                const response = await fetch('/api/crm/leads', { credentials: 'include' });
                console.log('Leads response:', response.status);
                
                if (!response.ok) {
                    console.error('Failed to load leads:', response.status);
                    return;
                }
                
                const leads = await response.json();
                console.log('Leads loaded:', leads.length);
                
                // Clear all columns
                stages.forEach(stage => {
                    const column = document.getElementById(`column-${stage.id}`);
                    if (column) {
                        column.innerHTML = '';
                        const countEl = document.getElementById(`count-${stage.id}`);
                        if (countEl) countEl.textContent = '0';
                    }
                });
                
                // Populate columns
                leads.forEach(lead => {
                    addLeadCard(lead);
                });
                
                document.getElementById('totalLeads').textContent = leads.length;
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }
        
        function addLeadCard(lead) {
            const column = document.getElementById(`column-${lead.stage_id}`);
            if (!column) return;
            
            const card = document.createElement('div');
            card.className = 'lead-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md';
            card.dataset.leadId = lead.id;
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <h4 class="font-semibold text-gray-800 text-sm">${lead.name || 'Sem nome'}</h4>
                    <button onclick="deleteLeadConfirm(${lead.id})" class="text-gray-400 hover:text-red-500">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
                ${lead.phone ? `<p class="text-xs text-gray-500 mb-1"><i class="fas fa-phone mr-1"></i> ${lead.phone}</p>` : ''}
                ${lead.email ? `<p class="text-xs text-gray-500 mb-1"><i class="fas fa-envelope mr-1"></i> ${lead.email}</p>` : ''}
                ${lead.interestedCourse ? `<span class="inline-block mt-2 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">${lead.interestedCourse}</span>` : ''}
            `;
            
            column.appendChild(card);
            
            // Update count
            const count = column.querySelectorAll('.lead-card').length;
            document.getElementById(`count-${lead.stage_id}`).textContent = count;
        }
        
        async function handleDrop(evt) {
            const leadId = evt.item.dataset.leadId;
            const newStageId = evt.to.dataset.stageId;
            
            try {
                await fetch(`/api/crm/leads/${leadId}/stage`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ stage_id: newStageId })
                });
                
                // Update counts
                stages.forEach(stage => {
                    const column = document.getElementById(`column-${stage.id}`);
                    const count = column.querySelectorAll('.lead-card').length;
                    document.getElementById(`count-${stage.id}`).textContent = count;
                });
                
            } catch (error) {
                console.error('Error updating lead:', error);
                loadLeads(); // Reload on error
            }
        }
        
        function openAddLeadModal() {
            document.getElementById('addLeadModal').classList.remove('hidden');
        }
        
        function closeAddLeadModal() {
            document.getElementById('addLeadModal').classList.add('hidden');
            document.getElementById('addLeadForm').reset();
        }
        
        document.getElementById('addLeadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                await fetch('/api/crm/leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                closeAddLeadModal();
                loadLeads();
            } catch (error) {
                console.error('Error adding lead:', error);
                alert('Erro ao adicionar lead');
            }
        });
        
        async function deleteLeadConfirm(id) {
            if (!confirm('Deseja realmente deletar este lead?')) return;
            
            try {
                await fetch(`/api/crm/leads/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadLeads();
            } catch (error) {
                console.error('Error deleting lead:', error);
            }
        }
        
        function initSocket() {
            socket = io();
            socket.emit('join-crm', 1); // userId
            
            socket.on('crm-update', () => {
                loadLeads();
            });
        }
        
        init();
    </script>
    
</body>
</html>
