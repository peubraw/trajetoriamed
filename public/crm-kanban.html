<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Kanban - TrajetóriaMed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            --primary-purple: #6366f1;
            --primary-purple-dark: #4f46e5;
            --primary-purple-light: #818cf8;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        body { 
            background: var(--bg-secondary); 
            color: var(--text-primary);
        }
        
        /* Sidebar Styling */
        .sidebar-gradient { 
            background: linear-gradient(180deg, #6366f1 0%, #4f46e5 100%); 
        }
        .nav-item { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            border-left: 3px solid transparent; 
        }
        .nav-item:hover { 
            background: rgba(255, 255, 255, 0.12); 
            border-left-color: #ffffff; 
        }
        .nav-item.active { 
            background: rgba(255, 255, 255, 0.18); 
            border-left-color: #ffffff;
            font-weight: 600;
        }
        
        /* Button Styles */
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--primary-purple-dark) 100%); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.15);
        }
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3); 
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white;
            border: 1.5px solid var(--border-color);
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            border-color: var(--primary-purple-light);
            color: var(--primary-purple);
            background: #f8f9ff;
        }
        
        /* Header Styles */
        .page-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Search Bar */
        .search-container {
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        .search-container:focus-within {
            background: white;
            border-color: var(--primary-purple-light);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Kanban Columns */
        .kanban-column { 
            min-height: calc(100vh - 280px);
            background: var(--bg-tertiary);
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        .kanban-column-header {
            background: white;
            border-bottom: 2px solid var(--border-color);
        }
        
        /* Lead Cards */
        .lead-card { 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: grab;
            background: white;
            border: 1px solid var(--border-color);
        }
        .lead-card:hover { 
            transform: translateY(-3px) scale(1.01); 
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
            border-color: var(--primary-purple-light);
        }
        .lead-card:active { 
            cursor: grabbing;
            transform: scale(0.98);
        }
        
        /* Drag & Drop States */
        .sortable-ghost { 
            opacity: 0.5;
            background: var(--bg-tertiary);
            border: 2px dashed var(--primary-purple-light);
        }
        .sortable-chosen { 
            transform: rotate(3deg);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        .sortable-drag {
            opacity: 1 !important;
        }
        
        /* Badges */
        .badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            letter-spacing: 0.025em;
        }
        
        /* Avatar Styles */
        .avatar {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--primary-purple-dark) 100%);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Loading Animation */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body class="content-container">
    
    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="sidebar-gradient w-64 flex-shrink-0 hidden md:flex flex-col shadow-2xl">
            <div class="p-6 border-b border-white border-opacity-10">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-white font-bold text-lg">TrajetóriaMed</h1>
                        <p class="text-white text-opacity-60 text-xs">Sistema CRM</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                <a href="/dashboard.html" class="nav-item flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fas fa-home w-5"></i>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="/crm-kanban.html" class="nav-item active flex items-center px-4 py-3 text-white rounded-lg">
                    <i class="fas fa-columns w-5"></i>
                    <span class="ml-3">CRM Kanban</span>
                </a>
                <a href="/crm-chat.html" class="nav-item flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fab fa-whatsapp w-5"></i>
                    <span class="ml-3">Chat WhatsApp</span>
                    <span id="chatUnreadBadge" class="ml-auto bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                </a>
                <a href="/whatsapp.html" class="nav-item admin-only flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fas fa-qrcode w-5"></i>
                    <span class="ml-3">Conectar WhatsApp</span>
                </a>
                <a href="/bot-config.html" class="nav-item admin-only flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fas fa-robot w-5"></i>
                    <span class="ml-3">Configurar Bot</span>
                </a>
                <a href="/webhooks.html" class="nav-item admin-only flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                    <i class="fas fa-link w-5"></i>
                    <span class="ml-3">Webhooks</span>
                </a>
                <div class="pt-6 mt-6 border-t border-white border-opacity-10 admin-only">
                    <a href="/settings.html" class="nav-item flex items-center px-4 py-3 text-white text-opacity-80 rounded-lg">
                        <i class="fas fa-cog w-5"></i>
                        <span class="ml-3">Configurações</span>
                    </a>
                </div>
            </nav>
            
            <div class="p-4 border-t border-white border-opacity-10">
                <div class="flex items-center px-4 py-3 bg-white bg-opacity-10 rounded-lg">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-purple-700 flex items-center justify-center text-white font-semibold">
                        <span id="userInitials">LB</span>
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate" id="userName">Leandro Berti</p>
                        <p class="text-xs text-white text-opacity-60 truncate" id="userRole">Admin</p>
                    </div>
                    <button onclick="logout()" class="text-white text-opacity-60 hover:text-opacity-100">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Top Bar -->
            <header class="page-header px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-6">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 tracking-tight">CRM Kanban</h1>
                            <p class="text-sm text-gray-500 mt-0.5 font-medium">Gerencie seu pipeline de vendas</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <div class="search-container hidden md:flex items-center rounded-xl px-4 py-2.5">
                            <i class="fas fa-search text-gray-400 text-sm"></i>
                            <input type="text" id="searchInput" placeholder="Buscar por nome, telefone ou email..." class="ml-3 bg-transparent outline-none text-sm text-gray-700 placeholder-gray-400 w-80" style="border: none;">
                        </div>
                        
                        <button class="relative p-2.5 text-gray-400 hover:text-gray-600 rounded-xl hover:bg-gray-100 transition-all">
                            <i class="fas fa-bell text-lg"></i>
                            <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white"></span>
                        </button>
                        
                        <div class="flex items-center space-x-3 pl-3 ml-2 border-l border-gray-200">
                            <div class="avatar w-10 h-10 text-white text-sm shadow-md">
                                <span>LB</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <main class="flex-1 overflow-x-auto overflow-y-hidden p-6" style="background: #f8fafc;">
                
                <!-- Action Bar -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 mb-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center space-x-3">
                            <button onclick="crmAdvanced.openLeadModal()" class="btn-primary text-white px-5 py-2.5 rounded-xl font-semibold flex items-center text-sm">
                                <i class="fas fa-plus mr-2"></i>
                                Novo Lead
                            </button>
                            <button onclick="crmAdvanced.openStagesModal()" class="btn-secondary text-gray-700 px-4 py-2.5 rounded-xl font-medium flex items-center text-sm">
                                <i class="fas fa-sliders-h mr-2"></i>
                                Gerenciar Pipeline
                            </button>
                            <div class="relative">
                                <button class="btn-secondary text-gray-700 px-4 py-2.5 rounded-xl font-medium flex items-center text-sm">
                                    <i class="fas fa-filter mr-2"></i>
                                    Filtros
                                    <i class="fas fa-chevron-down ml-2 text-xs"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
                                <i class="fas fa-users text-indigo-600 text-sm"></i>
                                <span class="text-sm font-semibold text-gray-700">Total: <span class="text-indigo-600" id="totalLeads">0</span> leads</span>
                            </div>
                            <button class="p-2.5 text-gray-400 hover:text-gray-600 rounded-xl hover:bg-gray-100 transition-all">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Kanban Board -->
                <div id="kanban-container" class="flex gap-4 pb-6" style="min-width: max-content;">
                    <!-- Colunas serão renderizadas via JavaScript -->
                </div>
                
            </main>
            
        </div>
        
    </div>
    
    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">Adicionar Novo Lead</h3>
            </div>
            <form id="addLeadForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                        <input type="text" name="name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                        <input type="tel" name="phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Curso de Interesse</label>
                        <select name="course" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">Selecione...</option>
                            <option value="Perícia Médica">Perícia Médica</option>
                            <option value="Auditoria">Auditoria</option>
                            <option value="Medicina do Trabalho">Medicina do Trabalho</option>
                            <option value="Combo">Combo</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddLeadModal()" class="px-6 py-3 border-2 border-gray-200 text-gray-700 rounded-lg font-semibold hover:border-gray-300">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold shadow-lg">
                        Adicionar Lead
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let socket;
        let stages = [];
        
        // Initialize
        async function init() {
            console.log('Initializing CRM Kanban...');
            await checkAuth();
            await loadStages();
            await loadLeads();
            initSocket();
        }
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', { credentials: 'include' });
                console.log('Auth check response status:', response.ok);
                
                if (!response.ok) {
                    console.log('Auth check failed, redirecting to login...');
                    window.location.href = '/login.html';
                    return false;
                }
                
                const data = await response.json();
                console.log('Auth data:', data);
                
                if (!data.authenticated) {
                    console.log('Not authenticated, redirecting to login...');
                    window.location.href = '/login.html';
                    return false;
                }
                
                console.log('User authenticated:', data.user);
                
                // Ocultar menus para vendedores
                if (data.user && data.user.role === 'seller') {
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = 'none';
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login.html';
                return false;
            }
        }
        
        function logout() {
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
                .then(() => window.location.href = '/login.html');
        }
        
        async function loadStages() {
            try {
                console.log('Loading stages...');
                const response = await fetch('/api/crm/stages', { credentials: 'include' });
                console.log('Stages response:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Stages data received:', data);
                    
                    // Handle both response formats
                    stages = Array.isArray(data) ? data : (data.stages || []);
                    console.log('Stages array:', stages);
                    
                    if (stages.length === 0) {
                        console.warn('No stages found, creating defaults...');
                        await createDefaultStages();
                        return;
                    }
                    
                    renderColumns();
                } else {
                    console.error('Failed to load stages:', response.status);
                    await createDefaultStages();
                }
            } catch (error) {
                console.error('Error loading stages:', error);
                await createDefaultStages();
            }
        }
        
        async function createDefaultStages() {
            try {
                const response = await fetch('/api/crm/stages/init', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    console.log('Default stages created, reloading...');
                    // Reload stages after creation
                    const stagesResponse = await fetch('/api/crm/stages', { credentials: 'include' });
                    const data = await stagesResponse.json();
                    stages = Array.isArray(data) ? data : (data.stages || []);
                    renderColumns();
                } else {
                    console.error('Failed to create default stages');
                }
            } catch (error) {
                console.error('Error creating default stages:', error);
            }
        }
        
        function renderColumns() {
            console.log('Rendering columns for stages:', stages);
            const container = document.getElementById('kanbanColumns');
            const colors = ['blue', 'purple', 'green', 'amber', 'red', 'gray', 'pink'];
            
            container.innerHTML = stages.map((stage, index) => `
                <div class="flex-shrink-0" style="width: 320px;">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 h-full flex flex-col">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-${colors[index % colors.length]}-500 mr-2"></div>
                                    <h3 class="font-semibold text-gray-800">${stage.name}</h3>
                                </div>
                                <span class="bg-gray-100 text-gray-600 text-xs font-semibold px-2 py-1 rounded-full" id="count-${stage.id}">0</span>
                            </div>
                        </div>
                        <div class="flex-1 p-4 space-y-3 kanban-column overflow-y-auto" id="column-${stage.id}" data-stage-id="${stage.id}">
                            <!-- Cards will be inserted here -->
                        </div>
                    </div>
                </div>
            `).join('');
            
            console.log('Columns rendered, initializing Sortable...');
            
            // Initialize Sortable for each column
            stages.forEach(stage => {
                const column = document.getElementById(`column-${stage.id}`);
                if (column) {
                    Sortable.create(column, {
                        group: 'kanban',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        onEnd: handleDrop
                    });
                }
            });
            
            console.log('Sortable initialized');
        }
        
        async function loadLeads() {
            try {
                console.log('Loading leads...');
                const response = await fetch('/api/crm/leads', { credentials: 'include' });
                console.log('Leads response:', response.status);
                
                if (!response.ok) {
                    console.error('Failed to load leads:', response.status);
                    return;
                }
                
                const data = await response.json();
                console.log('Leads data received:', data);
                
                // Handle both response formats: direct array or {success, leads}
                const leads = Array.isArray(data) ? data : (data.leads || []);
                console.log('Leads array:', leads.length, 'leads');
                
                // Clear all columns
                stages.forEach(stage => {
                    const column = document.getElementById(`column-${stage.id}`);
                    if (column) {
                        column.innerHTML = '';
                        const countEl = document.getElementById(`count-${stage.id}`);
                        if (countEl) countEl.textContent = '0';
                    }
                });
                
                // Populate columns
                leads.forEach(lead => {
                    console.log('Adding lead card:', lead.name, 'to stage:', lead.stage_id);
                    addLeadCard(lead);
                });
                
                document.getElementById('totalLeads').textContent = leads.length;
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }
        
        function addLeadCard(lead) {
            console.log('addLeadCard called with:', lead);
            const column = document.getElementById(`column-${lead.stage_id}`);
            if (!column) {
                console.warn('Column not found for stage_id:', lead.stage_id);
                return;
            }
            
            const card = document.createElement('div');
            card.className = 'lead-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md';
            card.dataset.leadId = lead.id;
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <h4 class="font-semibold text-gray-800 text-sm">${lead.name || 'Sem nome'}</h4>
                    <div class="flex gap-2">
                        ${lead.phone ? `
                            <button onclick="openChat('${lead.phone}', '${lead.name || lead.phone}', ${lead.id})" 
                                    class="text-green-500 hover:text-green-600 transition-colors" 
                                    title="Abrir Chat WhatsApp">
                                <i class="fab fa-whatsapp text-sm"></i>
                            </button>
                        ` : ''}
                        <button onclick="deleteLeadConfirm(${lead.id})" class="text-gray-400 hover:text-red-500">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
                ${lead.phone ? `<p class="text-xs text-gray-500 mb-1"><i class="fas fa-phone mr-1"></i> ${lead.phone}</p>` : ''}
                ${lead.email ? `<p class="text-xs text-gray-500 mb-1"><i class="fas fa-envelope mr-1"></i> ${lead.email}</p>` : ''}
                ${lead.interestedCourse ? `<span class="inline-block mt-2 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">${lead.interestedCourse}</span>` : ''}
            `;
            
            column.appendChild(card);
            console.log('Card added to column');
            
            // Update count
            const count = column.querySelectorAll('.lead-card').length;
            document.getElementById(`count-${lead.stage_id}`).textContent = count;
            console.log('Column count updated:', count);
        }
        
        async function handleDrop(evt) {
            const leadId = evt.item.dataset.leadId;
            const newStageId = evt.to.dataset.stageId;
            
            try {
                await fetch(`/api/crm/leads/${leadId}/stage`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ stage_id: newStageId })
                });
                
                // Update counts
                stages.forEach(stage => {
                    const column = document.getElementById(`column-${stage.id}`);
                    const count = column.querySelectorAll('.lead-card').length;
                    document.getElementById(`count-${stage.id}`).textContent = count;
                });
                
            } catch (error) {
                console.error('Error updating lead:', error);
                loadLeads(); // Reload on error
            }
        }
        
        function openAddLeadModal() {
            document.getElementById('addLeadModal').classList.remove('hidden');
        }
        
        function closeAddLeadModal() {
            document.getElementById('addLeadModal').classList.add('hidden');
            document.getElementById('addLeadForm').reset();
        }
        
        document.getElementById('addLeadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                await fetch('/api/crm/leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                closeAddLeadModal();
                loadLeads();
            } catch (error) {
                console.error('Error adding lead:', error);
                alert('Erro ao adicionar lead');
            }
        });
        
        async function deleteLeadConfirm(id) {
            if (!confirm('Deseja realmente deletar este lead?')) return;
            
            try {
                await fetch(`/api/crm/leads/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadLeads();
            } catch (error) {
                console.error('Error deleting lead:', error);
            }
        }
        
        let currentUserId = null;

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const data = await response.json();
                if (!data.authenticated) {
                    window.location.href = '/login.html';
                    return;
                }
                
                // Atualizar informações do usuário
                const user = data.user;
                currentUserId = user.id;
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                // Atualizar sidebar
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userInitials').textContent = initials;
                document.getElementById('userRole').textContent = user.role === 'seller' ? 'Vendedor' : 'Administrador';
                
                // Ocultar menus para vendedores
                if (user.role === 'seller') {
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = 'none';
                    });
                }
                
                // Inicializar socket com userId correto
                initSocket();
                
            } catch (error) {
                window.location.href = '/login.html';
            }
        }

        function initSocket() {
            socket = io();
            socket.emit('join-crm', currentUserId);
            
            socket.on('crm-update', () => {
                loadLeads();
            });

            // Socket para chat - atualizar badge de mensagens não lidas
            socket.on('new-message-notification', (data) => {
                updateChatBadge();
            });
        }

        // Abrir chat com lead
        function openChat(phone, name, leadId) {
            // Salvar no sessionStorage para abrir direto no chat
            sessionStorage.setItem('openChatPhone', phone);
            sessionStorage.setItem('openChatName', name);
            sessionStorage.setItem('openChatLeadId', leadId);
            
            // Redirecionar para página de chat
            window.location.href = '/crm-chat.html';
        }

        // Atualizar badge de mensagens não lidas
        async function updateChatBadge() {
            try {
                const response = await fetch('/api/chat/stats', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('chatUnreadBadge');
                    
                    if (data.stats && data.stats.total_unread > 0) {
                        badge.textContent = data.stats.total_unread;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar badge de chat:', error);
            }
        }
        
        function logout() {
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
                .then(() => window.location.href = '/login.html');
        }
        
        // Chamar checkAuth antes de init
        checkAuth().then(() => {
            init();
            updateChatBadge(); // Carregar badge inicial
            setInterval(updateChatBadge, 30000); // Atualizar a cada 30 segundos
        });
    </script>
    
    <!-- Modals -->
    <script>
        fetch('/crm-modals.html')
            .then(response => response.text())
            .then(html => {
                const div = document.createElement('div');
                div.innerHTML = html;
                document.body.appendChild(div);
            });
    </script>
    
    <!-- CRM Advanced Features -->
    <script src="/js/crm-kanban-advanced.js"></script>
    
</body>
</html>
